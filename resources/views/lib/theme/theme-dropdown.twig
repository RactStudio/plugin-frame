<div class="pf-py-1 sm:pf-py-1" pf-data="darkModeToggle">
    <!-- Dropdown -->
    <div class="pf-relative pf-flex pf-justify-center pf-items-center pf-mb-6">
        <!-- Dropdown Trigger -->
        <button 
            id="pfThemeDropdownButton" 
            aria-expanded="false" 
            class="pf-flex pf-items-center pf-w-28 pf-gap-2 pf-px-4 pf-py-2 pf-font-sans pf-bg-gray-200 pf-rounded-md pf-shadow-md pf-text-gray-700 hover:pf-bg-gray-300 pf-dark:pf-text-gray-200 pf-dark:pf-bg-gray-700 pf-dark:hover:pf-bg-gray-600"
            type="button"
            onclick="toggleDropdown()"
        >
            <span id="selectedModeIcon" class="pf-h-6 pf-w-6 pf-text-gray-800 pf-dark:pf-text-gray-200">
                <svg 
                    id="dropdownArrowIcon" 
                    xmlns="http://www.w3.org/2000/svg" 
                    class="pf-h-6 pf-w-6 pf-transform pf-transition-transform"
                    viewBox="0 0 24 24" 
                    fill="currentColor"
                >
                    <path d="M5.292 7.293a1 1 0 011.414 0L12 12.586l5.293-5.293a1 1 0 011.414 1.414l-6 6a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414z" />
                </svg>
            </span>
            <span id="selectedModeText" class="hidden sm:pf-inline">Theme</span>
        </button>

        <!-- Dropdown Menu -->
        <div 
            id="pfThemeDropdown" 
            class="hidden pf-items-center pf-z-10 pf-w-28 pf-bg-white pf-rounded-md pf-shadow-lg pf-border pf-border-gray-200 pf-dark:pf-bg-gray-800 pf-dark:pf-border-gray-600 pf-absolute pf-top-full pf-mt-1"
        >
            <ul class="pf-py-1" aria-labelledby="pfThemeDropdownButton">
                <li>
                    <!-- Light Mode Button -->
                    <button 
                        id="lightModeButton"
                        type="button" 
                        class="pf-flex pf-items-center pf-w-full pf-gap-2 pf-px-4 pf-py-2 pf-font-sans pf-text-gray-700 hover:pf-bg-gray-200 pf-dark:pf-text-gray-200 pf-dark:hover:pf-bg-gray-600"
                        onclick="selectOption('light', this)">
                        <svg xmlns="http://www.w3.org/2000/svg"
                            enable-background="new 0 0 30 30"
                            class="pf-h-6 pf-w-6 pf-text-gray-800 pf-dark:pf-text-gray-200" 
                            viewBox="0 0 24 24" 
                            fill="currentColor">
                            <path d="m4.37 14.62c0-.24.08-.45.25-.62.17-.16.38-.24.6-.24h2.04c.23 0 .42.08.58.25.15.17.23.37.23.61s-.07.44-.22.61-.35.25-.58.25h-2.04c-.23 0-.43-.08-.6-.25s-.26-.37-.26-.61zm2.86 6.93c0-.23.08-.43.23-.61l1.47-1.43c.15-.16.35-.23.59-.23s.44.08.6.23.24.34.24.57c0 .24-.08.46-.24.64l-1.42 1.42c-.41.32-.82.32-1.23 0-.16-.16-.24-.36-.24-.59zm0-13.84c0-.23.08-.43.23-.61.2-.17.41-.25.64-.25.22 0 .42.08.59.24l1.43 1.47c.16.15.24.35.24.59s-.08.44-.24.6-.36.24-.6.24-.44-.08-.59-.24l-1.46-1.43c-.16-.16-.24-.37-.24-.61zm2.55 6.91c0-.93.23-1.8.7-2.6s1.1-1.44 1.91-1.91 1.67-.7 2.6-.7c.7 0 1.37.14 2.02.42.64.28 1.2.65 1.66 1.12.47.47.84 1.02 1.11 1.66s.41 1.32.41 2.02c0 .94-.23 1.81-.7 2.61s-1.1 1.43-1.9 1.9-1.67.7-2.61.7-1.81-.23-2.61-.7-1.43-1.1-1.9-1.9c-.45-.81-.69-1.68-.69-2.62zm1.7 0c0 .98.34 1.81 1.03 2.5.68.69 1.51 1.04 2.49 1.04s1.81-.35 2.5-1.04 1.04-1.52 1.04-2.5c0-.96-.35-1.78-1.04-2.47-.69-.68-1.52-1.02-2.5-1.02-.97 0-1.8.34-2.48 1.02-.7.69-1.04 1.51-1.04 2.47zm2.66 7.78c0-.24.08-.44.25-.6s.37-.24.6-.24c.24 0 .45.08.61.24s.24.36.24.6v1.99c0 .24-.08.45-.25.62s-.37.25-.6.25-.44-.08-.6-.25c-.17-.17-.25-.38-.25-.62zm0-15.5v-2.04c0-.23.08-.43.25-.6s.37-.26.61-.26.43.08.6.25.25.37.25.6v2.05c0 .23-.08.42-.25.58s-.37.23-.6.23-.44-.08-.6-.23-.26-.35-.26-.58zm5.52 13.18c0-.23.08-.42.23-.56.15-.16.34-.23.56-.23.24 0 .44.08.6.23l1.46 1.43c.16.17.24.38.24.61s-.08.43-.24.59c-.4.31-.8.31-1.2 0l-1.42-1.42c-.15-.18-.23-.39-.23-.65zm0-10.92c0-.25.08-.45.23-.59l1.42-1.47c.17-.16.37-.24.59-.24.24 0 .44.08.6.25.17.17.25.37.25.6 0 .25-.08.46-.24.62l-1.46 1.43c-.18.16-.38.24-.6.24-.23 0-.41-.08-.56-.24s-.23-.36-.23-.6zm2.26 5.46c0-.24.08-.44.24-.62.16-.16.35-.24.57-.24h2.02c.23 0 .43.09.6.26s.26.37.26.6-.09.43-.26.6-.37.25-.6.25h-2.02c-.23 0-.43-.08-.58-.25s-.23-.36-.23-.6z"/>
                        </svg>
                        Light
                    </button>
                </li>
                <li>
                    <!-- Dark Mode Button -->
                    <button 
                        id="darkModeButton"
                        type="button" 
                        class="pf-flex pf-items-center pf-w-full pf-gap-2 pf-px-4 pf-py-2 pf-font-sans pf-text-gray-700 hover:pf-bg-gray-200 pf-dark:pf-text-gray-200 pf-dark:hover:pf-bg-gray-600"
                        onclick="selectOption('dark', this)">
                        <svg xmlns="http://www.w3.org/2000/svg" 
                            class="pf-h-6 pf-w-6 pf-text-gray-800 pf-dark:pf-text-gray-200" 
                            viewBox="0 0 24 24" 
                            fill="currentColor">
                            <path d="M12 3c-.13 0-.26.005-.39.014A8.002 8.002 0 0011.64 21 9 9 0 0012 3zm-1.036 14.899A6.008 6.008 0 018.485 5.85a7.965 7.965 0 002.479 12.048z"/>
                        </svg>
                        Dark
                    </button>
                </li>
                <li>
                    <!-- System Mode Button -->
                    <button 
                        id="systemModeButton"
                        type="button" 
                        class="pf-flex pf-items-center pf-w-full pf-gap-2 pf-px-4 pf-py-2 pf-font-sans pf-text-gray-700 hover:pf-bg-gray-200 pf-dark:pf-text-gray-200 pf-dark:hover:pf-bg-gray-600"
                        onclick="selectOption('system', this)">
                        <svg xmlns="http://www.w3.org/2000/svg"
                            class="pf-h-6 pf-w-6 pf-text-gray-800 pf-dark:pf-text-gray-200" 
                            viewBox="0 0 24 24" 
                            fill="currentColor">
                            <path d="M12,22 C17.5228475,22 22,17.5228475 22,12 C22,6.4771525 17.5228475,2 12,2 C6.4771525,2 2,6.4771525 2,12 C2,17.5228475 6.4771525,22 12,22 Z M12,20.5 L12,3.5 C16.6944204,3.5 20.5,7.30557963 20.5,12 C20.5,16.6944204 16.6944204,20.5 12,20.5 Z"/>
                        </svg>
                        System
                    </button>
                </li>
            </ul>
        </div>
    </div>
</div>

<script>
    let currentMode = localStorage.getItem('plugin_frame_theme') || 'system'; // Default to system if nothing is in localStorage
    let dropdownOpened = false; // Track whether the dropdown is open or not

    // Set the initial theme based on the stored mode
    document.addEventListener('DOMContentLoaded', function() {
        const selectedButton = document.querySelector(`#${currentMode}ModeButton`);
        selectOption(currentMode, selectedButton); // Apply the selected mode on page load

        // Ensure dropdown is closed on initial page load
        const dropdown = document.getElementById('pfThemeDropdown');
        dropdown.classList.add('hidden');

        // Close the dropdown if clicked outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('pfThemeDropdown');
            const dropdownButton = document.getElementById('pfThemeDropdownButton');

            if (!dropdown.contains(event.target) && !dropdownButton.contains(event.target) && dropdownOpened) {
                dropdown.classList.add('hidden');
                dropdownOpened = false;
            }
        });
    });

    function selectOption(mode, button) {
        currentMode = mode;
        localStorage.setItem('plugin_frame_theme', mode); // Save the mode in localStorage

        // Remove the active class from all buttons
        const allButtons = document.querySelectorAll('#pfThemeDropdown button');
        allButtons.forEach(btn => btn.classList.remove('pf-bg-gray-200', 'pf-dark:pf-bg-gray-700')); // Remove active class

        // Add active class to the selected button
        button.classList.add('pf-bg-gray-200', 'pf-dark:pf-bg-gray-700'); // Add active class to the selected button

        // Update button text
        const selectedText = document.getElementById('selectedModeText');
        selectedText.textContent = mode.charAt(0).toUpperCase() + mode.slice(1);

        // Update the button icon
        const selectedIcon = document.getElementById('selectedModeIcon');
        selectedIcon.innerHTML = button.querySelector('svg').outerHTML;

        // Close the dropdown
        toggleDropdown();

        // Apply the selected mode
        toggleMode(mode);
    }

    function toggleDropdown() {
        const dropdown = document.getElementById('pfThemeDropdown');
        
        // Toggle the dropdown visibility
        if (dropdownOpened) {
            dropdown.classList.add('hidden');
            dropdownOpened = false;
        } else {
            dropdown.classList.remove('hidden');
            dropdownOpened = true;
        }
    }

    // Function to handle mode change
    function toggleMode(mode) {
        const htmlElement = document.documentElement;

        // Apply the selected mode via data-mode attribute
        htmlElement.setAttribute('data-mode', 'pf-' + mode);

        if (mode === 'system') {
            if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                htmlElement.setAttribute('data-mode', 'pf-dark');
            } else {
                htmlElement.setAttribute('data-mode', 'pf-light');
            }
        }
    }
</script>
